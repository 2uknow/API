# 휴대폰결제 취소 테스트 시나리오 (암호화 + HTTP POST)
name: "휴대폰결제 취소 완전 프로세스"
description: "dncrypt 암호화 후 HTTP POST로 취소 요청 처리 테스트"
version: "1.0.0"

# 변수 정의
variables:
  # 기본 정보
  MERCHANT_ID: "A010002002"
  MERCHANT_PWD: "bbbbb"
  ORDER_ID: "{{js: 'CANCEL_' + Date.now() + '_' + Math.floor(Math.random() * 1000)}}"
  CANCEL_REASON: "고객 요청"

  # 암호화 키 (실제 환경에서는 보안 설정 필요)
  CRYPTO_KEY: "DANAL_CANCEL_KEY_2024"

  # 취소 API 엔드포인트 (실제 환경에 맞게 수정)
  CANCEL_API_URL: "https://testapi.danal.co.kr/mobile/cancel"

  # 원거래 정보 (기존 결제에서 받은 값들)
  ORIGINAL_TID: "T202501180001"
  ORIGINAL_AMOUNT: "1000"
  ORIGINAL_DATE: "{{$date}}"

# 시나리오 단계
steps:
  # 1단계: 취소 요청 데이터 생성
  - name: "취소 데이터 준비"
    description: "취소 요청에 필요한 데이터를 JSON 형태로 준비"
    type: "sclient"

    args:
      Command: "PREPARE_CANCEL"
      MerchantId: "{{MERCHANT_ID}}"
      OrderId: "{{ORDER_ID}}"
      OriginalTid: "{{ORIGINAL_TID}}"
      CancelAmount: "{{ORIGINAL_AMOUNT}}"
      CancelReason: "{{CANCEL_REASON}}"
      Timestamp: "{{$timestamp}}"

    # 취소 데이터 JSON 생성 (실제로는 내부 로직으로 생성)
    extract:
      - name: "result"
        pattern: "Result"
        variable: "PREPARE_RESULT"
      - name: "cancelData"
        pattern: "CancelData"
        variable: "CANCEL_JSON_DATA"

    test:
      - name: "취소 데이터 준비 성공 확인"
        description: "취소 데이터가 정상적으로 준비되었는지 확인"
        assertion: "PREPARE_RESULT == 0"

  # 2단계: 취소 데이터 암호화
  - name: "취소 데이터 암호화"
    description: "dncrypt를 사용하여 취소 데이터를 암호화"
    type: "crypto"

    args:
      operation: "encrypt"
      data: "{{CANCEL_JSON_DATA}}"
      key: "{{CRYPTO_KEY}}"

    # 암호화 결과 추출
    extract:
      - name: "result"
        pattern: "result"
        variable: "ENCRYPTED_CANCEL_DATA"

    test:
      - name: "암호화 성공 확인"
        description: "취소 데이터가 정상적으로 암호화되었는지 확인"
        assertion: "ENCRYPTED_CANCEL_DATA exists"
      - name: "암호화 데이터 길이 확인"
        description: "암호화된 데이터의 길이가 원본보다 긴지 확인"
        assertion: "js: ENCRYPTED_CANCEL_DATA && ENCRYPTED_CANCEL_DATA.length > 10"

  # 3단계: HTTP POST 취소 요청
  - name: "휴대폰결제 취소 요청"
    description: "암호화된 데이터로 HTTP POST 취소 요청 전송"
    type: "http"

    args:
      url: "{{CANCEL_API_URL}}"
      headers:
        Content-Type: "application/x-www-form-urlencoded"
        X-Merchant-ID: "{{MERCHANT_ID}}"
        X-Request-ID: "{{ORDER_ID}}"
        Authorization: "Bearer DANAL_API_TOKEN"
      body: "merchant_id={{MERCHANT_ID}}&encrypted_data={{ENCRYPTED_CANCEL_DATA}}&timestamp={{$timestamp}}"

    # HTTP 응답에서 데이터 추출
    extract:
      - name: "status"
        pattern: "status"
        variable: "HTTP_STATUS"
      - name: "body"
        pattern: "body"
        variable: "CANCEL_RESPONSE"
      # JSON 응답에서 결과 코드 추출 (정규식 사용)
      - name: "resultCode"
        pattern: '"result_code"\\s*:\\s*"([^"]+)"'
        variable: "CANCEL_RESULT_CODE"
      - name: "cancelTid"
        pattern: '"cancel_tid"\\s*:\\s*"([^"]+)"'
        variable: "CANCEL_TID"

    test:
      - name: "HTTP 응답 상태 확인"
        description: "HTTP 응답이 200 OK인지 확인"
        assertion: "HTTP_STATUS == 200"
      - name: "취소 응답 데이터 존재 확인"
        description: "취소 응답 데이터가 존재하는지 확인"
        assertion: "CANCEL_RESPONSE exists"
      - name: "취소 결과 코드 확인"
        description: "취소가 성공적으로 처리되었는지 확인 (0000 = 성공)"
        assertion: "CANCEL_RESULT_CODE == 0000"
      - name: "취소 거래번호 발급 확인"
        description: "취소 거래번호(TID)가 정상 발급되었는지 확인"
        assertion: "CANCEL_TID exists"

  # 4단계: 취소 응답 데이터 복호화 (선택사항)
  - name: "취소 응답 복호화"
    description: "암호화된 응답이 있다면 복호화하여 상세 정보 확인"
    type: "crypto"

    args:
      operation: "decrypt"
      data: "{{CANCEL_RESPONSE}}"
      key: "{{CRYPTO_KEY}}"

    # 복호화 결과 추출
    extract:
      - name: "result"
        pattern: "result"
        variable: "DECRYPTED_RESPONSE"

    test:
      - name: "응답 복호화 성공 확인"
        description: "응답 데이터가 정상적으로 복호화되었는지 확인"
        assertion: "DECRYPTED_RESPONSE exists"
      - name: "복호화된 데이터 검증"
        description: "복호화된 데이터에 취소 정보가 포함되어 있는지 확인"
        assertion: "js: DECRYPTED_RESPONSE && (DECRYPTED_RESPONSE.includes('cancel') || DECRYPTED_RESPONSE.includes('success'))"

  # 5단계: 취소 결과 검증
  - name: "최종 취소 결과 검증"
    description: "전체 취소 프로세스의 성공 여부를 최종 검증"
    type: "sclient"

    args:
      Command: "VERIFY_CANCEL"
      OriginalTid: "{{ORIGINAL_TID}}"
      CancelTid: "{{CANCEL_TID}}"
      MerchantId: "{{MERCHANT_ID}}"

    extract:
      - name: "result"
        pattern: "Result"
        variable: "VERIFY_RESULT"
      - name: "cancelStatus"
        pattern: "CancelStatus"
        variable: "FINAL_CANCEL_STATUS"

    test:
      - name: "최종 검증 성공 확인"
        description: "취소 검증이 성공적으로 완료되었는지 확인"
        assertion: "VERIFY_RESULT == 0"
      - name: "취소 상태 최종 확인"
        description: "취소 상태가 '완료'로 표시되는지 확인"
        assertion: "js: FINAL_CANCEL_STATUS && (FINAL_CANCEL_STATUS === 'COMPLETED' || FINAL_CANCEL_STATUS === '완료')"
      - name: "전체 프로세스 성공 확인"
        description: "암호화, HTTP 요청, 복호화가 모두 성공했는지 통합 확인"
        assertion: "js: ENCRYPTED_CANCEL_DATA && HTTP_STATUS == '200' && CANCEL_RESULT_CODE == '0000' && CANCEL_TID"

# 시나리오 설정
options:
  stopOnError: false
  timeout: 30000
  retryCount: 0