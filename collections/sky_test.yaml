# 🚀 완전 자동화된 SKT SMS 테스트 
name: "SKT SMS 완전 테스트 (자동화)"
description: "common.yaml 기반 완전 자동화된 5단계 결제 플로우 테스트"
version: "1.0.0"

# 🎯 이제 이것만 있으면 모든 설정이 자동!
include: common.yaml

# 추가 테스트용 변수
variables:
  TEST_SCENARIO: "SKT_FULL_PAYMENT_FLOW"
  CUSTOM_AMOUNT: "1000"

# 5단계 결제 플로우
steps:
  # 1단계: ITEMSEND2 - 가맹점 인증 및 상품정보 검증
  - name: "{{SERVICE_NAME}} - ITEMSEND2 요청"
    description: "가맹점 인증 및 상품정보 검증 요청"
    
    args:
      Command: "ITEMSEND2"
      Configure: "FAILURE"
      SERVICE: "{{SERVICE_NAME}}"
      ItemType: "Amount"
      ItemCount: "1"
      OUTPUTOPTION: "DEFAULT"
      ID: "{{MERCHANT_ID}}"
      PWD: "{{MERCHANT_PWD}}"
      ItemInfo: "2|{{CUSTOM_AMOUNT}}|1|22S0HZ0100|상품명"
      SUBCP: "DETEST"
      USERID: "{{USER_ID}}"
      ORDERID: "{{ORDER_ID}}"
      IsPreOtbill: "N"
      IsOpenMarket: "N"
      SellerName: ""
      SellerTel: ""
      IsSubscript: "N"
      EMAIL: "{{EMAIL}}"
    
    # 추가 커스텀 테스트 (공통 테스트에 자동 추가됨)
    test:
      - name: "{{TEST_SCENARIO}} 거래 인증키 검증"
        description: "SERVER_INFO가 정상적으로 생성되었는지 확인"
        assertion: "js: SERVER_INFO !== null && SERVER_INFO.trim().length > 0"

  # 2단계: IDELIVER - 사용자정보 인증 및 승인번호 발송
  - name: "{{SERVICE_NAME}} - IDELIVER 인증"
    description: "사용자정보 인증 및 승인번호 발송 요청"
    
    args:
      ServerInfo: "{{SERVER_INFO}}"          # 이전 단계 자동 추출
      IDEN: "{{IDEN}}"                       # SKT 기본값 자동
      ISPREOTBILL: "N"
      DSTADDR: "{{DST_ADDR}}"                # SKT 기본값 자동
      CARRIER: "{{CARRIER}}"                 # SKT 기본값 자동
      WPAGE: "WEB"
      PRCODE: ""
      AMOUNT: "{{CUSTOM_AMOUNT}}"
      TERMSAGREE3: "N"
      IFVERSION: "V1.1.7"
      TERMSAGREE2: "N|N"
      OUTPUTOPTION: "1"
      COMMAND: "IDELIVER"
      TERMSAGREE1: "Y"
      IPADDR: "{{IPADDR}}"                   # 공통 설정 자동
      SMTOTP: "N"
      ISCPIN: "Y"
      CPIN: "663466"
    
    # 상세 추출 (공통 추출에 추가)
    extract:
      - name: "cap"
        pattern: "CAP"
        variable: "ID_CAP"
      - name: "ansimMember"
        pattern: "ANSIMMEMBER"
        variable: "ID_ANSIMMEMBER"
      - name: "arsChange"
        pattern: "ARSCHANGE"
        variable: "ID_ARSCHANGE"
      - name: "uam"
        pattern: "UAM"
        variable: "ID_UAM"
    
    # 상세 검증 테스트
    test:
      - name: "잔여한도 금액 검증"
        description: "개인정보 보호를 위해 잔여한도는 000000으로 마스킹"
        assertion: "ID_CAP == 000000"
      - name: "안심결제 회원 여부 확인"
        assertion: "ID_ANSIMMEMBER == N"
      - name: "ARS 전환 지원 확인"
        assertion: "ID_ARSCHANGE == N"
      - name: "인증 방식 확인"
        assertion: "ID_UAM == 0"

  # 3단계: IREPORT - 승인번호 확인 (실패 예상)
  - name: "{{SERVICE_NAME}} - IREPORT 승인번호 확인"
    description: "승인번호 확인 요청 (잘못된 OTP로 실패 테스트)"
    
    args:
      ServerInfo: "{{SERVER_INFO}}"
      Command: "IREPORT"
      Configure: "FAILURE"
      IFVERSION: "V1.0.5"
      TERMSAGREE2: "N"
      WPRCODE: "0000"
      ANSIMPASS: ""
      ANSIMMEMBER: "N"
      OTP: "000000"                          # 의도적으로 잘못된 OTP
    
    test:
      - name: "승인번호 불일치 오류 확인"
        description: "잘못된 OTP로 인한 482 오류 코드 확인"
        assertion: "RESULT_CODE == 482"
      - name: "승인번호 불일치 메시지 확인"
        assertion: "ERROR_MSG == 승인 번호가 일치하지 않습니다. 확인 후 다시 시도해 주십시오."

  # 4단계: NCONFIRM - 결제정보 검증 (승인 절차 미완료 예상)
  - name: "{{SERVICE_NAME}} - NCONFIRM 결제정보 검증"
    description: "결제정보 검증 요청 (승인 절차 미완료로 실패 예상)"
    
    args:
      ServerInfo: "{{SERVER_INFO}}"
      Command: "NCONFIRM"
      OUTPUTOPTION: "DEFAULT"
      ConfirmOption: "1"
      CPID: "{{MERCHANT_ID}}"
      AMOUNT: "301"
    
    test:
      - name: "승인 절차 미완료 오류 확인"
        description: "승인 절차 미완료로 인한 492 오류 코드 확인"
        assertion: "RESULT_CODE == 492"
      - name: "승인 절차 미완료 메시지 확인"
        assertion: "ERROR_MSG == 승인 절차를 모두 거치지 않고 거래가 시도되었습니다. 다시 시도해 주십시오."

  # 5단계: NBILL - 결제 요청 (승인 절차 미완료 예상)
  - name: "{{SERVICE_NAME}} - NBILL 결제 요청"
    description: "최종 결제 요청 (승인 절차 미완료로 실패 예상)"
    
    args:
      ServerInfo: "{{SERVER_INFO}}"
      BillOption: "1"
      Command: "NBILL"
      OUTPUTOPTION: "DEFAULT"
    
    test:
      - name: "결제 승인 절차 미완료 오류 확인"
        description: "승인 절차 미완료로 인한 492 오류 코드 확인"
        assertion: "RESULT_CODE == 492"
      - name: "결제 승인 절차 미완료 메시지 확인"
        assertion: "ERROR_MSG == 승인 절차를 모두 거치지 않고 거래가 시도되었습니다. 다시 시도해 주십시오."

# 모든 공통 설정(추출 패턴, 기본 테스트, options)은 자동 적용됨!