name: "EXPREBILL-PCancel SMS 비점유결제 부분취소"
description: "Danal_Teledit_v1.0 자동화 테스트"
version: "1.0.0"

# 공통 변수 불러오기
include: Danal_Teledit_Cancel_v1.0/conf.yaml


# ** ----------------------------------------------------------------------------------------------------------------
#  * [1차 호출] EXPREBILL
#  * ----------------------------------------------------------------------------------------------------------------*

steps:
  - name: "EXPREBILL"
    description: "비점유 결제 + AUTHKEY 전송"

    args:
      Command: "EXPREBILL"
      ID: "{{MERCHANT_ID}}"
      PWD: "{{MERCHANT_PWD}}"
      ItemCount: "1"
      ItemType: "0"
      ItemInfo: "2|3001|1|22S0HZ0100|상품명"
      #AUTHKEY: "20250901101636D6FFC6"
      AUTHKEY: "20201229093719D4EF17"
      ORDERID: "{{ORDER_ID}}"
      OUTPUTOPTION: "3"
      TIDTYPE: "1"
      IFVERSION: "V1.1.2"
      BILLTYPE: "1"

    # 응답 데이터 추출
    extract:
      - name: "result"
        pattern: "Result"
        variable: "RESULT_CODE"
      - name: "errMsg"
        pattern: "ErrMsg"
        variable: "ERROR_MESSAGE"
      - name: "tid"
        pattern: "TID"
        variable: "TID"
      - name: "date"
        pattern: "Date"
        variable: "DATE"
      - name: "totalAmount"
        pattern: "TotalAmount"
        variable: "TOTAL_AMOUNT"
      - name: "cap"
        pattern: "Cap"
        variable: "CAP"
      - name: "orderid"
        pattern: "Orderid"
        variable: "RESPONSE_ORDER_ID"
      - name: "dstAddr"
        pattern: "DstAddr"
        variable: "DSTADDR"
      - name: "carrier"
        pattern: "Carrier"
        variable: "CARRIER"
      - name: "dntid"
        pattern: "Dntid"
        variable: "DN_TID"

####################################################### Assertion ###########################################################

    test:
      - name: "결과 코드(RESULT) 정상 출력"
        assertion: "RESULT_CODE == 0"

      - name: "결과 메시지(ErrMsg) 정상 출력"
        assertion: "ERROR_MESSAGE == No Information"

      - name: "거래 번호(TID) 정상 출력"
        assertion: "js: (
          TID !== null &&
          typeof TID !== 'undefined' &&
          typeof TID === 'string' &&
          TID.trim().length === 18)"

      - name: "결제 완료 시간(Date) 정상 출력_1"
        assertion: "js: (
          DATE !== null &&
          typeof DATE !== 'undefined' &&
          typeof DATE === 'string' &&
          DATE.trim().length === 14)"

      - name: "결제 완료 시간(Date) 정상 출력_2"
        description: "Date가 현재 시각(yyyymmddhhmmss)과 일치하는지 확인"
        assertion: "js: (() => {
          const pad = n => String(n).padStart(2,'0');
          const d = new Date();
          const now12 = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}${pad(d.getHours())}${pad(d.getMinutes())}`;
          return DATE.slice(0, 12) === now12;})()"

      - name: "전체 결제금액(TotalAmount) 정상 출력"
        assertion: "TOTAL_AMOUNT == 301"

      - name: "거래 전 한도 금액(CAP) 정상 출력"
        assertion: "CAP == 000000"

      - name: "CP 주문번호(ORDERID) 정상 출력"
        assertion: "js: (
          typeof RESPONSE_ORDER_ID !== 'undefined' &&
          typeof RESPONSE_ORDER_ID === 'string' &&
          RESPONSE_ORDER_ID.trim().length > 0 &&
          RESPONSE_ORDER_ID.includes('ORD'))"

      - name: "사용자 전화번호(DstAddr) 정상 출력"
        assertion: "DSTADDR == 01085402697"

      - name: "인증 받은 통신사 정보(Carrier) 정상 출력"
        assertion: "CARRIER == KTF"

      - name: "거래 번호(DNTID) 정상 출력_1"
        assertion: "js: DN_TID && DN_TID.trim().length > 0 && /^\\d{22}$/.test(DN_TID)"

      - name: "거래 번호(DNTID) 정상 출력_2"
        description: "DN_TID가 현재 시각(yyyymmddhhmmss)과 일치하는지 확인"
        assertion: "js: (() => {
          const pad = n => String(n).padStart(2,'0');
          const d = new Date();
          const now12 = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}${pad(d.getHours())}${pad(d.getMinutes())}`;
          return DN_TID.slice(0, 12) === now12;})()"


# ** ----------------------------------------------------------------------------------------------------------------
#  * [2차 호출] PCancel 데이터 암호화
#  * ----------------------------------------------------------------------------------------------------------------*

  - name: "PCancel 데이터 암호화"
    description: "취소 요청 데이터를 암호화"
    type: "crypto"

    args:
      operation: "encrypt"
      key: "{{PCANCEL_CRYPTOKEY}}"
      data: "TID={{TID}}|PWD={{MERCHANT_PWD}}|ORDERID={{RESPONSE_ORDER_ID}}|CAMT=1500"
      sleepDuration: 5000   # 암호화 후 대기 시간 (밀리초)

    # 암호화 결과 추출
    extract:
      - name: "result"
        pattern: "result"
        variable: "ENCRYPTED_PCANCEL_DATA"

    test:
      - name: "PCancel 데이터 암호화 성공 확인"
        assertion: "ENCRYPTED_PCANCEL_DATA exists"
      - name: "암호화 데이터 길이 확인"
        assertion: "js: ENCRYPTED_PCANCEL_DATA && ENCRYPTED_PCANCEL_DATA.length > 20"

# ** ----------------------------------------------------------------------------------------------------------------
#  * [대기] 암호화 후 대기 - 암호화 단계에 통합됨
#  * ----------------------------------------------------------------------------------------------------------------*

#  - name: "암호화 후 대기"
#    description: "시스템 안정화를 위한 20초 대기 (암호화 단계에 통합됨)"
#    type: "sleep"
#
#    args:
#      duration: 20000  # 20초 (밀리초)
#
#    test:
#      - name: "대기 완료 확인"
#        assertion: "js: true"

# ** ----------------------------------------------------------------------------------------------------------------
#  * [3차 호출] PCancel - HTTP POST 요청
#  * ----------------------------------------------------------------------------------------------------------------*

  - name: "PCancel HTTP 요청"
    description: "부분 취소 HTTP POST 요청"
    type: "http"

    args:
      url: "{{PCANCEL_URL}}"
      method: "POST"
      headers:
        Content-Type: "application/x-www-form-urlencoded"
        User-Agent: "2uknow-api-monitor/1.0.0"
      body: "DATA={{ENCRYPTED_PCANCEL_DATA}}&CPID={{CPID}}&ISCHARSET={{ISCHARSET}}"

    # HTTP 응답 데이터 추출
    extract:
      - name: "status"
        pattern: "status"
        variable: "HTTP_STATUS"
      - name: "body"
        pattern: "body"
        variable: "RESPONSE_BODY"
      - name: "encrypted_data"
        pattern: "DATA=(.+)"
        variable: "SERVER_ENCRYPTED_DATA"

    # 테스트 검증
    test:
      - name: "HTTP 응답 상태 확인"
        assertion: "HTTP_STATUS == 200"
      - name: "응답 본문 존재 확인"
        assertion: "RESPONSE_BODY exists"
      - name: "응답 본문 길이 확인"
        assertion: "js: RESPONSE_BODY && RESPONSE_BODY.length > 0"

# ** ----------------------------------------------------------------------------------------------------------------
#  * [4차 호출] PCancel 응답 복호화 (응답이 암호화된 경우)
#  * ----------------------------------------------------------------------------------------------------------------*

  - name: "PCancel 응답 복호화"
    description: "HTTP 응답에서 받은 실제 암호화된 데이터를 복호화"
    type: "crypto"

    args:
      operation: "decrypt"
      key: "{{PCANCEL_CRYPTOKEY}}"
      data: "{{SERVER_ENCRYPTED_DATA}}"

    # 복호화 결과 추출 (자동 파싱된 필드들)
    extract:
      - name: "result"
        pattern: "result"
        variable: "PCANCEL_RESULT"
      - name: "tid"
        pattern: "tid"
        variable: "PCANCEL_TID"
      - name: "otid"
        pattern: "otid"
        variable: "PCANCEL_OTID"
      - name: "orderid"
        pattern: "orderid"
        variable: "PCANCEL_ORDERID"
      - name: "remainamt"
        pattern: "remainamt"
        variable: "PCANCEL_REMAINAMT"
      - name: "errmsg"
        pattern: "errmsg"
        variable: "PCANCEL_ERRMSG"
      - name: "date"
        pattern: "date"
        variable: "PCANCEL_DATE"
      - name: "dntid"
        pattern: "dntid"
        variable: "PCANCEL_DNTID"

####################################################### Assertion ###########################################################

    test:
      - name: "복호화 결과(Result) 정상 출력"
        description: "부분취소 결과 코드가 0(성공)인지 확인"
        assertion: "PCANCEL_RESULT == 0"

      - name: "취소 거래번호(TID) 정상 출력"
        description: "복호화된 취소 거래번호가 존재하고 18자리인지 확인"
        assertion: "js: PCANCEL_TID && PCANCEL_TID.length === 18"

      - name: "원본 거래번호(OTID) 정상 출력"
        description: "복호화된 원본 TID가 최초 결제 TID와 일치하는지 확인"
        assertion: "js: PCANCEL_OTID && PCANCEL_OTID === TID"

      - name: "주문번호(Orderid) 정상 출력"
        description: "복호화된 주문번호가 원본 주문번호와 일치하는지 확인"
        assertion: "js: PCANCEL_ORDERID && PCANCEL_ORDERID === RESPONSE_ORDER_ID"

      - name: "잔액(REMAINAMT) 정상 출력"
        description: "부분취소 후 남은 금액이 올바른지 확인 (3001 - 1500 = 1501)"
        assertion: "PCANCEL_REMAINAMT == 1501"

      - name: "취소 일시(DATE) 정상 출력"
        description: "복호화된 취소 일시가 존재하고 14자리인지 확인"
        assertion: "js: PCANCEL_DATE && PCANCEL_DATE.length === 14"

      - name: "취소 DNTID 정상 출력"
        description: "복호화된 DNTID가 존재하고 22자리인지 확인"
        assertion: "js: PCANCEL_DNTID && PCANCEL_DNTID.length === 22"

      - name: "에러메시지(ErrMsg) 확인"
        description: "성공 시 에러메시지가 'No Information'인지 확인"
        assertion: "js: PCANCEL_RESULT == 0 ? PCANCEL_ERRMSG === 'No Information' : PCANCEL_ERRMSG && PCANCEL_ERRMSG.length > 0"

# 시나리오 설정
options:
  stopOnError: false
  timeout: 15000
  retryCount: 0