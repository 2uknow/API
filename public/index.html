<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>API ìë™í™” ëª¨ë‹ˆí„°ë§</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/ansi_up@5.2.1/ansi_up.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold">API ìë™í™” ëª¨ë‹ˆí„°ë§</h1>
        <p class="text-sm text-slate-500">Newman API í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ëª¨ë‹ˆí„°ë§</p>
      </div>
      <div class="flex items-center space-x-3">
        <span id="statusChip" class="text-xs px-2 py-1 rounded bg-slate-200">ëŒ€ê¸°</span>
        <span id="connectionStatus" class="text-xs px-2 py-1 rounded bg-green-100 text-green-800">ì—°ê²°ë¨</span>
        <a href="/alert-config.html" class="px-3 py-1.5 text-xs bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          âš™ï¸ ì•ŒëŒ ì„¤ì •
        </a>
      </div>
    </header>

    <section class="grid grid-cols-1 xl:grid-cols-3 gap-5">
      <div class="bg-white rounded-2xl shadow p-4 space-y-3">
        <div class="text-sm font-semibold">ì¡ ì„ íƒ ë° ì‹¤í–‰</div>
        <select id="jobSelect" class="w-full border rounded px-3 py-2"></select>
        <div class="flex gap-2">
          <button id="runBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all">ì‹¤í–‰</button>
          <button id="clearConsole" class="px-4 py-2 rounded-xl border">ì½˜ì†” ì§€ìš°ê¸°</button>
        </div>
        <div class="text-xs text-slate-500">ì¡ ì„¤ì •</div>
        <div id="jobSummary" class="text-xs bg-slate-50 border rounded p-3 min-h-[120px]"></div>
        
        <!-- ì‹¤í–‰ ìƒíƒœ í‘œì‹œ -->
        <div id="runningStatus" class="hidden text-xs bg-blue-50 border border-blue-200 rounded p-3">
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
            <span class="text-blue-700 font-medium">ì‹¤í–‰ ì¤‘...</span>
          </div>
          <div id="runningJob" class="text-blue-600 mt-1"></div>
        </div>

        <!-- ì•ŒëŒ ìƒíƒœ -->
        <div class="text-xs text-slate-500">ì•ŒëŒ ì„¤ì •</div>
        <div id="alertStatus" class="text-xs bg-slate-50 border rounded p-3">
          <div class="flex items-center justify-between">
            <span>ìƒíƒœ í™•ì¸ ì¤‘...</span>
 hover:text-indigo-800">ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </div>
      </div>

      <div class="xl:col-span-2 bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm font-semibold">ì‹¤í–‰ íˆìŠ¤í† ë¦¬</div>
          <div class="flex items-center space-x-2 text-xs">
            <button id="refreshHistory" class="px-2 py-1 border rounded hover:bg-slate-50">ìƒˆë¡œê³ ì¹¨</button>
            <select id="pageSize" class="border rounded px-2 py-1">
              <option value="20">20ê°œ</option>
              <option value="50" selected>50ê°œ</option>
              <option value="100">100ê°œ</option>
            </select>
          </div>
        </div>

        <!-- í•„í„° -->
        <div class="mb-3 flex flex-wrap gap-2 text-xs">
          <select id="filterJob" class="border rounded px-2 py-1">
            <option value="">ëª¨ë“  ì¡</option>
          </select>
          <select id="filterStatus" class="border rounded px-2 py-1">
            <option value="">ëª¨ë“  ìƒíƒœ</option>
            <option value="0">ì„±ê³µ</option>
            <option value="1">ì‹¤íŒ¨</option>
          </select>
          <input id="filterDate" type="date" class="border rounded px-2 py-1" />
          <button id="applyFilter" class="px-3 py-2 rounded border">ì ìš©</button>
          <button id="resetFilter" class="px-3 py-2 rounded border">ì´ˆê¸°í™”</button>
        </div>

        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead><tr class="text-left text-slate-500">
              <th class="py-2 pr-4" data-sort="timestamp">ì‹œê°„</th>
              <th class="py-2 pr-4" data-sort="job">ì¡</th>
              <th class="py-2 pr-4">ìœ í˜•</th>
              <th class="py-2 pr-4" data-sort="exitCode">ìƒíƒœ</th>
              <th class="py-2 pr-4">ìš”ì•½</th>
              <th class="py-2 pr-4">ì‹¤í–‰ì‹œê°„</th>
              <th class="py-2 pr-4">ë¦¬í¬íŠ¸</th>
              <th class="py-2">ë¡œê·¸</th>
            </tr></thead>
            <tbody id="histTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-sm font-semibold">ì‹¤ì‹œê°„ ì½˜ì†” (Newman ì›ë³¸)</div>
        <div class="flex items-center space-x-2 text-xs">
          <span class="text-slate-500">ì‹¤ì‹œê°„ ë¡œê·¸</span>
          <div id="logIndicator" class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
        </div>
      </div>
      <pre id="console" class="h-[420px] overflow-auto text-xs bg-slate-900 text-slate-100 rounded p-3 font-mono"></pre>
    </section>
  </div>

<script>
let jobs = [], running = null, pageSize = 50, historyRaw = [], historyView = [];
let ansiUp = new AnsiUp();
let stateEventSource = null, logEventSource = null;
let isConnected = false;

// ì—°ê²° ìƒíƒœ ê´€ë¦¬ ê°•í™”
function updateConnectionStatus(connected) {
  const status = document.getElementById('connectionStatus');
  isConnected = connected;
  if (connected) {
    status.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-800';
    status.textContent = 'ì—°ê²°ë¨';
  } else {
    status.className = 'text-xs px-2 py-1 rounded bg-red-100 text-red-800';
    status.textContent = 'ì—°ê²° ëŠê¹€';
    
    // ì—°ê²°ì´ ëŠì–´ì§€ë©´ ì¦‰ì‹œ ì¬ì—°ê²° ì‹œë„
    setTimeout(() => {
      if (!isConnected) {
        console.log('[CONNECTION] ì¬ì—°ê²° ì‹œë„ ì¤‘...');
        startSSE();
      }
    }, 1000);
  }
}

function setStatusChip() {
  const chip = document.getElementById('statusChip');
  const runningStatus = document.getElementById('runningStatus');
  const runningJob = document.getElementById('runningJob');
  const runBtn = document.getElementById('runBtn');
  
  if (running) {
    chip.textContent = 'ì‹¤í–‰ ì¤‘: ' + running.job;
    chip.className = 'text-xs px-2 py-1 rounded bg-amber-100 text-amber-800';
    runningStatus.classList.remove('hidden');
    runningJob.textContent = `ì¡: ${running.job} (ì‹œì‘: ${running.startAt})`;
    runBtn.disabled = true;
    runBtn.textContent = 'ì‹¤í–‰ ì¤‘...';
    runBtn.className = 'px-4 py-2 rounded-xl bg-gray-400 text-white cursor-not-allowed';
  } else {
    chip.textContent = 'ëŒ€ê¸°';
    chip.className = 'text-xs px-2 py-1 rounded bg-slate-200';
    runningStatus.classList.add('hidden');
    runBtn.disabled = false;
    runBtn.textContent = 'ì‹¤í–‰';
    runBtn.className = 'px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700';
  }
}

async function fetchJobs() {
  try {
    console.log('[UI] ì¡ ëª©ë¡ ìš”ì²­ ì‹œì‘...');
    const resp = await fetch('/api/jobs?' + Date.now()); // ìºì‹œ ë°©ì§€
    console.log(`[UI] ì¡ ëª©ë¡ ì‘ë‹µ ìƒíƒœ: ${resp.status}`);
    
    jobs = await resp.json();
    console.log(`[UI] ë°›ì€ ì¡ ëª©ë¡ (${jobs.length}ê°œ):`, jobs);
    
    const sel = document.getElementById('jobSelect');
    sel.innerHTML = '<option value="">ì¡ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    
    if (jobs.length === 0) {
      console.log('[UI] âš ï¸ ì¡ì´ ì—†ìŠµë‹ˆë‹¤!');
      sel.innerHTML = '<option value="">âŒ ì¡ì´ ì—†ìŠµë‹ˆë‹¤</option>';
    } else {
      jobs.forEach(j => {
        console.log(`[UI] ì¡ ì¶”ê°€: ${j.name} (${j.type})`);
        sel.innerHTML += `<option value="${j.name}">${j.name} (${j.type})</option>`;
      });
    }
    
    // í•„í„° ì˜µì…˜ë„ ì—…ë°ì´íŠ¸
    const filterJob = document.getElementById('filterJob');
    const currentFilter = filterJob.value;
    filterJob.innerHTML = '<option value="">ëª¨ë“  ì¡</option>';
    const uniqueJobs = [...new Set(jobs.map(j => j.name))];
    uniqueJobs.forEach(name => {
      filterJob.innerHTML += `<option value="${name}" ${currentFilter === name ? 'selected' : ''}>${name}</option>`;
    });
    
    console.log('[UI] ì¡ ëª©ë¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
  } catch (err) {
    console.error('[UI] âŒ ì¡ ë¡œë”© ì‹¤íŒ¨:', err);
    const sel = document.getElementById('jobSelect');
    sel.innerHTML = '<option value="">âŒ ë¡œë”© ì‹¤íŒ¨</option>';
  }
}

// íˆìŠ¤í† ë¦¬ ìë™ ê°±ì‹  ì¶”ê°€
let historyUpdateInterval = null;

async function fetchHistory() {
  try {
    const resp = await fetch(`/api/history?page=1&size=${pageSize}`);
    const data = await resp.json();
    historyRaw = data.items || [];
    
    // ì„œë²„ì—ì„œ ë°›ì€ ì‹¤í–‰ ìƒíƒœë„ ì—…ë°ì´íŠ¸
    if (data.running !== undefined) {
      const wasRunning = !!running;
      running = data.running;
      setStatusChip();
      
      // ì‹¤í–‰ ì‹œì‘ ì‹œ ìë™ ê°±ì‹  ì‹œì‘
      if (!wasRunning && running) {
        startHistoryAutoUpdate();
      }
      // ì‹¤í–‰ ì™„ë£Œ ì‹œ ìë™ ê°±ì‹  ì¤‘ì§€
      else if (wasRunning && !running) {
        stopHistoryAutoUpdate();
      }
    }
    
    applyFilters();
  } catch (err) {
    console.error('íˆìŠ¤í† ë¦¬ ë¡œë”© ì‹¤íŒ¨:', err);
  }
}

// íˆìŠ¤í† ë¦¬ ìë™ ê°±ì‹  ì‹œì‘
function startHistoryAutoUpdate() {
  if (historyUpdateInterval) return; // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ë³µ ë°©ì§€
  
  console.log('[HISTORY] ìë™ ê°±ì‹  ì‹œì‘');
  historyUpdateInterval = setInterval(() => {
    if (running) {
      fetchHistory();
    } else {
      stopHistoryAutoUpdate();
    }
  }, 3000); // 3ì´ˆë§ˆë‹¤ ê°±ì‹ 
}

// íˆìŠ¤í† ë¦¬ ìë™ ê°±ì‹  ì¤‘ì§€
function stopHistoryAutoUpdate() {
  if (historyUpdateInterval) {
    console.log('[HISTORY] ìë™ ê°±ì‹  ì¤‘ì§€');
    clearInterval(historyUpdateInterval);
    historyUpdateInterval = null;
  }
}

// ì„œë²„ ìƒíƒœ í™•ì¸
async function checkServerStatus() {
  try {
    const resp = await fetch('/api/status');
    const data = await resp.json();
    running = data.running;
    setStatusChip();
    return true;
  } catch (err) {
    console.error('ì„œë²„ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', err);
    return false;
  }
}

function updateJobSummary() {
  const name = document.getElementById('jobSelect').value;
  const div = document.getElementById('jobSummary');
  if (!name) {
    div.innerHTML = '<div class="text-center text-slate-400 py-4">ì¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>';
    return;
  }
  const job = jobs.find(j => j.name === name);
  if (!job) {
    div.innerHTML = '<div class="text-center text-red-500 py-4">âŒ ì¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  // ë©‹ì§„ ì¹´ë“œ í˜•íƒœë¡œ í‘œì‹œ
  const collectionName = job.collection.split('/').pop().replace('.postman_collection.json', '');
  const envName = job.environment ? job.environment.split('/').pop().replace('.postman_environment.json', '') : null;
  
  div.innerHTML = `
    <div class="space-y-3">
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-indigo-500 rounded-full"></div>
        <span class="font-semibold text-indigo-700">${job.name}</span>
      </div>
      
      <div class="grid grid-cols-1 gap-2 text-xs">
        <div class="flex items-center justify-between p-2 bg-slate-100 rounded">
          <span class="text-slate-600">ğŸ“ ì»¬ë ‰ì…˜</span>
          <span class="font-medium">${collectionName}</span>
        </div>
        ${envName ? `
        <div class="flex items-center justify-between p-2 bg-slate-100 rounded">
          <span class="text-slate-600">ğŸŒ í™˜ê²½</span>
          <span class="font-medium">${envName}</span>
        </div>` : ''}
        <div class="flex items-center justify-between p-2 bg-slate-100 rounded">
          <span class="text-slate-600">ğŸ“Š ë¦¬í¬í„°</span>
          <span class="font-medium">${job.reporters.length}ê°œ</span>
        </div>
      </div>
      
      <div class="flex flex-wrap gap-1">
        ${job.reporters.map(r => `<span class="px-2 py-1 text-xs bg-indigo-100 text-indigo-700 rounded">${r}</span>`).join('')}
      </div>
    </div>
  `;
}

async function checkAlertStatus() {
  try {
    const resp = await fetch('/api/alert/config');
    const config = await resp.json();
    const div = document.getElementById('alertStatus');
    
    const enabled = config.run_event_alert;
    const webhook = config.webhook_url !== 'ë¯¸ì„¤ì •';
    
    let statusText = enabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';
    let statusClass = enabled && webhook ? 'text-green-600' : 'text-slate-500';
    
    div.innerHTML = `
      <div class="flex items-center justify-between">
        <div>
          <span class="${statusClass}">${statusText}</span>
          ${!webhook ? '<span class="text-red-500 ml-2">(ì›¹í›… ë¯¸ì„¤ì •)</span>' : ''}
        </div>
        <button id="refreshAlert" class="text-indigo-600 hover:text-indigo-800">ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="text-xs text-slate-400 mt-1">
        ì‹œì‘: ${config.alert_on_start ? 'âœ“' : 'âœ—'} | 
        ì„±ê³µ: ${config.alert_on_success ? 'âœ“' : 'âœ—'} | 
        ì‹¤íŒ¨: ${config.alert_on_error ? 'âœ“' : 'âœ—'}
      </div>
    `;
    
    document.getElementById('refreshAlert').onclick = checkAlertStatus;
  } catch (err) {
    console.error('ì•ŒëŒ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', err);
    document.getElementById('alertStatus').innerHTML = '<span class="text-red-500">ìƒíƒœ í™•ì¸ ì‹¤íŒ¨</span>';
  }
}

function applyFilters() {
  const jobFilter = document.getElementById('filterJob').value;
  const statusFilter = document.getElementById('filterStatus').value;
  const dateFilter = document.getElementById('filterDate').value;
  
  historyView = historyRaw.filter(row => {
    // ì¡ í•„í„°
    if (jobFilter && row.job !== jobFilter) return false;
    
    // ìƒíƒœ í•„í„°
    if (statusFilter && row.exitCode.toString() !== statusFilter) return false;
    
    // ë‚ ì§œ í•„í„° (ê°„ë‹¨í•˜ê²Œ ìˆ˜ì •)
    if (dateFilter) {
      const rowDate = new Date(row.timestamp);
      const filterDate = new Date(dateFilter);
      
      const rowDateStr = rowDate.toISOString().split('T')[0];
      const filterDateStr = filterDate.toISOString().split('T')[0];
      
      if (rowDateStr !== filterDateStr) return false;
    }
    
    return true;
  });
  
  renderHistory();
}

function renderHistory() {
  const tbody = document.getElementById('histTbody');
  tbody.innerHTML = '';
  
  // ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬ (timestamp ë‚´ë¦¼ì°¨ìˆœ)
  const sortedHistory = [...historyView].sort((a, b) => b.timestamp - a.timestamp);
  
  sortedHistory.forEach(row => {
    // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜ (ê¹”ë”í•œ í˜•ì‹)
    const date = new Date(row.timestamp);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    
    const displayTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    
    const duration = row.duration ? `${row.duration}ì´ˆ` : '-';
    tbody.innerHTML += `
      <tr class="border-b hover:bg-slate-50">
        <td class="py-1 pr-4 text-xs text-slate-600">${displayTime}</td>
        <td class="py-1 pr-4 text-xs font-medium">${row.job}</td>
        <td class="py-1 pr-4 text-xs">${row.type}</td>
        <td class="py-1 pr-4">${row.exitCode === 0 ? 
          '<span class="text-emerald-700 text-sm">âœ… ì„±ê³µ</span>' : 
          '<span class="text-rose-700 text-sm">âŒ ì‹¤íŒ¨</span>'}</td>
        <td class="py-1 pr-4 text-xs">${(row.summary || '').replace(/</g, '&lt;')}</td>
        <td class="py-1 pr-4 text-xs text-slate-600">${duration}</td>
        <td class="py-1 pr-4">${row.report ? 
          ('<a class="text-indigo-600 underline text-xs" href="' + 
           row.report.replace(/^.*[\\/]reports[\\/]/, '/reports/') + 
           '" target="_blank">ğŸ“Š HTML</a>') : ''}</td>
        <td class="py-1"><a class="text-slate-700 underline text-xs" href="/logs/${row.stdout}" target="_blank">ğŸ“„ stdout</a></td>
      </tr>`;
  });
}

// SSE ì—°ê²° ê°•í™” - ì—°ê²° ë¬¸ì œ í•´ê²°
function startSSE() {
  // ê¸°ì¡´ ì—°ê²° ì •ë¦¬
  if (stateEventSource) {
    stateEventSource.close();
    stateEventSource = null;
  }
  if (logEventSource) {
    logEventSource.close();
    logEventSource = null;
  }

  console.log('[SSE] ì—°ê²° ì‹œì‘...');

  // State EventSource - ì—°ê²° ê°•í™”
  stateEventSource = new EventSource('/api/stream/state');
  
  stateEventSource.addEventListener('connected', e => {
    console.log('[SSE] State ìŠ¤íŠ¸ë¦¼ ì—°ê²° í™•ì¸ë¨');
    updateConnectionStatus(true);
  });
  
  stateEventSource.addEventListener('state', e => {
    const payload = JSON.parse(e.data);
    const wasRunning = !!running;
    
    // ì„œë²„ ìƒíƒœë¡œ ë®ì–´ì“°ê¸°
    running = payload.running || null;
    setStatusChip();
    
    console.log('[SSE] ìƒíƒœ ì—…ë°ì´íŠ¸:', running ? `ì‹¤í–‰ ì¤‘ (${running.job})` : 'ëŒ€ê¸°');
    
    if (wasRunning && !running) {
      // ì‹¤í–‰ ì™„ë£Œ ì‹œ ì¦‰ì‹œ íˆìŠ¤í† ë¦¬ ìƒˆë¡œê³ ì¹¨
      console.log('[SSE] ì‹¤í–‰ ì™„ë£Œ - íˆìŠ¤í† ë¦¬ ìƒˆë¡œê³ ì¹¨');
      fetchHistory();
      setTimeout(checkAlertStatus, 500);
    }
  });
  
  stateEventSource.addEventListener('heartbeat', e => {
    console.log('[SSE] State heartbeat received');
  });
  
  stateEventSource.addEventListener('open', () => {
    console.log('[SSE] State ì—°ê²° ì„±ê³µ');
    updateConnectionStatus(true);
  });
  
  stateEventSource.addEventListener('error', (e) => {
    console.log('[SSE] State ì—°ê²° ì˜¤ë¥˜:', e);
    updateConnectionStatus(false);
    
    // ì¦‰ì‹œ ì¬ì—°ê²° ì‹œë„
    if (stateEventSource.readyState === EventSource.CLOSED) {
      setTimeout(() => {
        console.log('[SSE] State ì¬ì—°ê²° ì‹œë„...');
        startSSE();
      }, 2000);
    }
  });

  // Log EventSource - ì—°ê²° ê°•í™”
  logEventSource = new EventSource('/api/stream/logs?recent=true');
  
  logEventSource.addEventListener('connected', e => {
    console.log('[SSE] Log ìŠ¤íŠ¸ë¦¼ ì—°ê²° í™•ì¸ë¨');
    document.getElementById('logIndicator').className = 'w-2 h-2 bg-green-400 rounded-full animate-pulse';
  });
  
  logEventSource.addEventListener('log', e => {
    const { line, id } = JSON.parse(e.data);
    const con = document.getElementById('console');
    
    // ì¤‘ë³µ ë¡œê·¸ ë°©ì§€
    if (!con.dataset.lastLogId || con.dataset.lastLogId !== id.toString()) {
      con.insertAdjacentHTML('beforeend', ansiUp.ansi_to_html(line) + '<br/>');
      con.dataset.lastLogId = id.toString();
      con.scrollTop = con.scrollHeight;
    }
  });
  
  logEventSource.addEventListener('heartbeat', e => {
    // heartbeatì€ ë¡œê·¸ì— ì¶œë ¥í•˜ì§€ ì•ŠìŒ
  });
  
  logEventSource.addEventListener('open', () => {
    console.log('[SSE] Log ì—°ê²° ì„±ê³µ');
    document.getElementById('logIndicator').className = 'w-2 h-2 bg-green-400 rounded-full animate-pulse';
  });
  
  logEventSource.addEventListener('error', (e) => {
    console.log('[SSE] Log ì—°ê²° ì˜¤ë¥˜');
    document.getElementById('logIndicator').className = 'w-2 h-2 bg-red-400 rounded-full';
    
    // ì¬ì—°ê²° ì‹œë„
    if (logEventSource.readyState === EventSource.CLOSED) {
      setTimeout(() => {
        console.log('[SSE] Log ì¬ì—°ê²° ì‹œë„...');
        startSSE();
      }, 2000);
    }
  });
}

// í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ì—°ê²° ê´€ë¦¬
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    // í˜ì´ì§€ê°€ ë³´ì´ê²Œ ë˜ì—ˆì„ ë•Œ ì„œë²„ ìƒíƒœ í™•ì¸
    setTimeout(checkServerStatus, 1000);
    
    // ì—°ê²°ì´ ëŠì–´ì¡Œë‹¤ë©´ ì¬ì—°ê²° ì‹œë„
    if (!isConnected) {
      setTimeout(startSSE, 1000);
    }
  }
});

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
document.getElementById('jobSelect').onchange = updateJobSummary;

document.getElementById('runBtn').onclick = async () => {
  const name = document.getElementById('jobSelect').value;
  const btn = document.getElementById('runBtn');
  
  if (!name) {
    alert('ì¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (running) {
    alert('ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ì¡ì´ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  console.log(`[UI] ì¡ ì‹¤í–‰ ìš”ì²­: ${name}`);
  
  // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
  btn.disabled = true;
  btn.textContent = 'ìš”ì²­ ì¤‘...';
  btn.className = 'px-4 py-2 rounded-xl bg-yellow-400 text-white cursor-not-allowed';
  
  // ì½˜ì†” í´ë¦¬ì–´
  document.getElementById('console').innerHTML = '';
  
  try {
    console.log(`[UI] API í˜¸ì¶œ ì‹œì‘: POST /api/run/${name}`);
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
    
    const resp = await fetch(`/api/run/${name}?` + Date.now(), {  // ìºì‹œ ë°©ì§€
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Cache-Control': 'no-cache'
      },
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    console.log(`[UI] API ì‘ë‹µ ìƒíƒœ: ${resp.status} ${resp.statusText}`);
    console.log(`[UI] ì‘ë‹µ í—¤ë”:`, [...resp.headers.entries()]);
    
    const contentType = resp.headers.get('content-type');
    let result;
    
    if (contentType && contentType.includes('application/json')) {
      result = await resp.json();
    } else {
      const text = await resp.text();
      console.log(`[UI] í…ìŠ¤íŠ¸ ì‘ë‹µ:`, text);
      throw new Error(`ì„œë²„ê°€ JSONì´ ì•„ë‹Œ ì‘ë‹µì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤: ${text.substring(0, 100)}`);
    }
    
    console.log(`[UI] API ì‘ë‹µ ë‚´ìš©:`, result);
    
    if (!resp.ok) {
      console.error(`[UI] ì‹¤í–‰ ì‹¤íŒ¨ (${resp.status}):`, result);
      
      // 409 ì—ëŸ¬ (ì´ë¯¸ ì‹¤í–‰ ì¤‘)ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
      if (resp.status === 409) {
        alert(`ë‹¤ë¥¸ íƒ­ì—ì„œ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤: ${result.current?.job || 'ì•Œ ìˆ˜ ì—†ëŠ” ì¡'}`);
      } else {
        alert(`ì‹¤í–‰ ì‹¤íŒ¨ (${resp.status}): ${result.message || result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
      }
      
      // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë³µì›
      btn.disabled = false;
      btn.textContent = 'ì‹¤í–‰';
      btn.className = 'px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700';
    } else {
      console.log(`[UI] âœ… ì‹¤í–‰ ìš”ì²­ ì„±ê³µ:`, result);
      
      // ì„±ê³µ ì‹œ ì¦‰ì‹œ ë¡œì»¬ ìƒíƒœ ì„¤ì •
      running = { job: name, startAt: new Date().toLocaleTimeString('ko-KR') };
      setStatusChip();
      
      console.log(`[UI] ë¡œì»¬ ìƒíƒœ ì„¤ì • ì™„ë£Œ, SSE ëŒ€ê¸° ì¤‘...`);
    }
  } catch (err) {
    console.error('[UI] âŒ ìš”ì²­ ì˜¤ë¥˜:', err);
    
    if (err.name === 'AbortError') {
      alert('ìš”ì²­ì´ 10ì´ˆ ë‚´ì— ì™„ë£Œë˜ì§€ ì•Šì•„ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
    } else {
      alert(`ìš”ì²­ ì˜¤ë¥˜: ${err.message}`);
    }
    
    // ì˜¤ë¥˜ ì‹œ ë²„íŠ¼ ë³µì›
    btn.disabled = false;
    btn.textContent = 'ì‹¤í–‰';
    btn.className = 'px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700';
  }
};

document.getElementById('clearConsole').onclick = async () => {
  // ì„œë²„ì— ë¡œê·¸ ì´ˆê¸°í™” ìš”ì²­
  try {
    await fetch('/api/logs/clear', { method: 'POST' });
  } catch (err) {
    console.error('ë¡œê·¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
  }
  
  // ë¡œì»¬ ì½˜ì†”ë„ ì¦‰ì‹œ ì§€ìš°ê¸°
  const con = document.getElementById('console');
  con.innerHTML = '';
  con.dataset.lastLogId = '';
};

document.getElementById('refreshHistory').onclick = fetchHistory;

document.getElementById('pageSize').onchange = (e) => {
  pageSize = parseInt(e.target.value);
  fetchHistory();
};

document.getElementById('applyFilter').onclick = applyFilters;
document.getElementById('resetFilter').onclick = () => {
  document.getElementById('filterJob').value = '';
  document.getElementById('filterStatus').value = '';
  document.getElementById('filterDate').value = '';
  applyFilters();
};

// ì´ˆê¸°í™”
async function init() {
  console.log('[INIT] ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”...');
  
  // ì„œë²„ ìƒíƒœ ë¨¼ì € í™•ì¸
  const serverOk = await checkServerStatus();
  if (!serverOk) {
    updateConnectionStatus(false);
  }
  
  await fetchJobs();
  await fetchHistory();
  await checkAlertStatus();
  
  startSSE();
  
  console.log('[INIT] ì´ˆê¸°í™” ì™„ë£Œ');
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
window.addEventListener('load', init);

// í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° ì •ë¦¬ ê°•í™”
window.addEventListener('beforeunload', () => {
  console.log('[CLEANUP] í˜ì´ì§€ ì¢…ë£Œ - ì—°ê²° ì •ë¦¬');
  if (stateEventSource) {
    stateEventSource.close();
    stateEventSource = null;
  }
  if (logEventSource) {
    logEventSource.close();
    logEventSource = null;
  }
});

// í˜ì´ì§€ ìˆ¨ê¹€ ì‹œì—ë„ ì—°ê²° ì •ë¦¬
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    console.log('[CLEANUP] í˜ì´ì§€ ìˆ¨ê¹€ - ì—°ê²° ì •ë¦¬');
    if (stateEventSource) stateEventSource.close();
    if (logEventSource) logEventSource.close();
  } else if (document.visibilityState === 'visible') {
    console.log('[CLEANUP] í˜ì´ì§€ í‘œì‹œ - ì—°ê²° ì¬ì‹œì‘');
    // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì´ë©´ ì—°ê²° ì¬ì‹œì‘
    setTimeout(() => {
      if (!stateEventSource || stateEventSource.readyState === EventSource.CLOSED) {
        startSSE();
      }
    }, 1000);
  }
});
</script>
</body>
</html>